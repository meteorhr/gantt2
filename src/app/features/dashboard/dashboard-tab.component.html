<div class="dash-viewport">
  <div class="dash-wrap">
    <!-- ИНДИКАТОР РАСЧЁТА -->
    @if (wm.dashLoading()) {
      <div class="topbar">
        <div class="grow">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </div>
        <span>{{ 'dashboard.calculating' | transloco }}</span>
      </div>
    } @else {
      @if (wm.dashboard(); as d) {
        <!-- KPIs -->

<div class="kpis">
  <!-- SPI -->
  <mat-card class="kpi-card" appearance="outlined">
    <mat-card-header>
      <mat-card-title>{{ 'dashboard.spi.title' | transloco }}</mat-card-title>
      <mat-card-subtitle>
        {{ 'dashboard.spi.as_of' | transloco : { date: (d.spi.asOf || '—') } }}
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <d3js-speedometer [config$]="spi$"></d3js-speedometer>
    </mat-card-content>
    <mat-card-actions>
      <button mat-button (click)="openSpiDialog(d)">
        {{ 'dashboard.open_table' | transloco }}
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- CPI -->
  <mat-card class="kpi-card" appearance="outlined">
    <mat-card-header>
      <mat-card-title>{{ 'dashboard.cpi.title' | transloco }}</mat-card-title>
      <mat-card-subtitle>
        {{ 'dashboard.cpi.as_of' | transloco : { date: (d.cpi.asOf || '—') } }}
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <d3js-speedometer [config$]="cpi$"></d3js-speedometer>
    </mat-card-content>
    <mat-card-actions>
      <button mat-button (click)="openCpiDialog(d)">
        {{ 'dashboard.open_table' | transloco }}
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Третий столбец: три карточки вертикально -->
  <div class="kpi-stack">
    <mat-card class="kpi-card" style="height: 157px" appearance="outlined">
      <mat-card-content>
        <div class="kpi-value">{{ d.totalTasks }}</div>
        <div class="kpi-caption">{{ 'dashboard.total_tasks' | transloco }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi-card" style="height: 156px; margin: 0" appearance="outlined">
      <mat-card-content>
        <div class="kpi-value">{{ nonEmptyRsrcCount() }}</div>
        <div class="kpi-caption">{{ 'dashboard.distinct_resources' | transloco }}</div>
      </mat-card-content>
    </mat-card>
    <!--
    <mat-card class="kpi-card" appearance="outlined">
      <mat-card-content>
        <div class="kpi-value-date">{{ d.lastRecalc || '—' }}</div>
        <div class="kpi-caption">{{ 'dashboard.last_recalc' | transloco }}</div>
      </mat-card-content>
    </mat-card>
    -->
  </div>
</div>



        <!-- ТАБЛИЦЫ -->
        <div class="tables">

          <!-- Project Dates -->
          <mat-card class="table-card" appearance="outlined">
            <mat-card-header>
              <mat-card-title>{{ 'dashboard.project_dates' | transloco }}</mat-card-title>
            </mat-card-header>
          
            <mat-card-content>
              <table mat-table [dataSource]="[
                { label: ('dashboard.start_date'  | transloco), date: (d.planStart  || '—') },
                { label: ('dashboard.data_date'   | transloco), date: (d.dataDate   || '—') },
                { label: ('dashboard.end_date'    | transloco), date: (d.planEnd    || '—') },
                { label: ('dashboard.must_finish' | transloco), date: (d.mustFinish || '—') }
              ]">
          
                <!-- Колонка 'Key' -->
                <ng-container matColumnDef="label">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.key' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ r.label }}</td>
                </ng-container>
          
                <!-- Колонка 'Date' -->
                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.date' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ r.date }}</td>
                </ng-container>
          
                <tr mat-header-row *matHeaderRowDef="['label','date']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['label','date'];"></tr>
              </table>
            </mat-card-content>
          </mat-card>

          <!-- Progress -->
          <mat-card class="table-card" appearance="outlined">
            <mat-card-header>
              <mat-card-title>{{ 'dashboard.progress' | transloco }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <table mat-table [dataSource]="[
                { label: ('dashboard.schedule' | transloco), value: d.progressSchedulePct },
                { label: ('dashboard.physical' | transloco), value: d.progressPhysicalPct },
                { label: ('dashboard.cost' | transloco),     value: d.progressCostPct }
              ]">
                <ng-container matColumnDef="label">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.value' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ r.label }}</td>
                </ng-container>
                <ng-container matColumnDef="percent">
                  <th mat-header-cell *matHeaderCellDef>%</th>
                  <td mat-cell *matCellDef="let r">
                    <div class="progress-cell">
                      <div class="progress-bar" [style.width.%]="r.value ?? 0"></div>
                      <span class="progress-text">{{ (r.value ?? 0) | number:'1.0-2' }}%</span>
                    </div>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['label','percent']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['label','percent'];"></tr>
              </table>
            </mat-card-content>
          </mat-card>

          <!-- By Status + TOTAL -->
<mat-card class="table-card" appearance="outlined">
  <mat-card-header>
    <mat-card-title>{{ 'dashboard.table_by_status' | transloco }}</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <table mat-table [dataSource]="d.byStatus">
      <ng-container matColumnDef="value">
        <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.status' | transloco }}</th>
        <td mat-cell *matCellDef="let r" >
            <span class="status-badge" [ngClass]="'status-' + r.value">
    {{ ('task.status_code.' + r.value) | transloco }}
  </span>
        </td>
        <td mat-footer-cell *matFooterCellDef>{{ 'dashboard.total' | transloco }}</td>
      </ng-container>

      <ng-container matColumnDef="count">
        <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.count' | transloco }}</th>
        <td mat-cell *matCellDef="let r">{{ r.count }}</td>
        <td mat-footer-cell *matFooterCellDef>{{ d.totalTasks }}</td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['value','count']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['value','count'];"></tr>
      <tr mat-footer-row *matFooterRowDef="['value','count']"></tr>
    </table>
  </mat-card-content>
</mat-card>
          <!-- By Task Type -->
          <mat-card class="table-card" appearance="outlined">
            <mat-card-header>
              <mat-card-title>{{ 'dashboard.table_by_task_type' | transloco }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <table mat-table [dataSource]="d.byTaskType">
                <ng-container matColumnDef="value">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.task' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ ('task.task_type.' + r.value) | transloco }}</td>
                </ng-container>
                <ng-container matColumnDef="count">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.count' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ r.count }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['value','count']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['value','count'];"></tr>
              </table>
            </mat-card-content>
          </mat-card>

          <!-- By Priority -->
          <mat-card class="table-card" appearance="outlined">
            <mat-card-header>
              <mat-card-title>{{ 'dashboard.table_by_priority' | transloco }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <table mat-table [dataSource]="d.byPriorityType">
                <ng-container matColumnDef="value">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.priority' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ ('task.priority_type.' + r.value) | transloco }}</td>
                </ng-container>
                <ng-container matColumnDef="count">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.count' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ r.count }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['value','count']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['value','count'];"></tr>
              </table>
            </mat-card-content>
          </mat-card>

          <!-- By Duration -->
          <mat-card class="table-card" appearance="outlined">
            <mat-card-header>
              <mat-card-title>{{ 'dashboard.table_by_duration_type' | transloco }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <table mat-table [dataSource]="d.byDurationType">
                <ng-container matColumnDef="value">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.duration' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ ('task.duration_type.' + r.value) | transloco }}</td>
                </ng-container>
                <ng-container matColumnDef="count">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.count' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ r.count }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['value','count']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['value','count'];"></tr>
              </table>
            </mat-card-content>
          </mat-card>
        </div>
        @if (d?.summarize?.fileType !== 'xer') {
        <div>
          <mat-card class="table-card" appearance="outlined">
            <mat-card-header>
              <mat-card-title>
                {{ 'dashboard.unitsByResources' | transloco : { defaultValue: 'Units by resources' } }}
              </mat-card-title>
          
              <div style="margin-left:auto; display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
                <!-- ВРЕМЕННОЙ ДИАПАЗОН -->
                <mat-form-field appearance="outline" style="min-width: 320px;">
                  <mat-label>
                    {{ 'dashboard.period' | transloco : { defaultValue: 'Period' } }}
                  </mat-label>
          
                  <mat-date-range-input [rangePicker]="picker">
                    <input
                      matStartDate
                      [placeholder]="'common.start' | transloco : { defaultValue: 'Start' }"
                      [value]="startDate"
                      (dateChange)="onStartChange($event)" />
                    <input
                      matEndDate
                      [placeholder]="'common.end' | transloco : { defaultValue: 'End' }"
                      [value]="endDate"
                      (dateChange)="onEndChange($event)" />
                  </mat-date-range-input>
          
                  <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                  <mat-date-range-picker #picker></mat-date-range-picker>
                </mat-form-field>
          
                <!-- МЕТРИКА -->
                <mat-form-field appearance="outline" style="min-width: 260px;">
                  <mat-label>
                    {{ 'dashboard.metric.units' | transloco : { defaultValue: 'Metric (Units)' } }}
                  </mat-label>
                  <mat-select [(value)]="selectedMeasure">
                    @for (m of measureOptions; track m) {
                      <mat-option [value]="m.key">
                        {{ 'dashboard.measures.' + m.label | transloco  }}
                      </mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            </mat-card-header>
          
            <mat-card-content>
              <!-- тонкая полоса прогресса под шапкой -->
              @if (loading) {
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              }
          
              <!-- Ошибка -->
              @if (error) {
                <div class="hpc-error">
                  <mat-icon color="warn" aria-hidden="true">error_outline</mat-icon>
                  <span>{{ error }}</span>
                  <button mat-stroked-button color="primary" (click)="loadHistogram()">
                    {{ 'common.retry' | transloco : { defaultValue: 'Retry' } }}
                  </button>
                </div>
              }
          
              <!-- Контент: график -->
              @if (!loading && !error) {
                <histogramPivotChart
                  [data]="histogramUnitsResult"
                  [height]="360"
                  [value]="selectedMeasure">
                </histogramPivotChart>
              }
            </mat-card-content>
          </mat-card>
          
        </div>
        }

        <div class="tables">
          <!-- By Resource -->
          <mat-card class="table-card" appearance="outlined">
            <mat-card-header>
              <mat-card-title>{{ 'dashboard.table_by_resource' | transloco }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <table mat-table [dataSource]="d.byRsrcId">
                <ng-container matColumnDef="value">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.resource' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ r.value }}</td>
                </ng-container>
                <ng-container matColumnDef="count">
                  <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.count' | transloco }}</th>
                  <td mat-cell *matCellDef="let r">{{ r.count }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['value','count']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['value','count'];"></tr>
              </table>
            </mat-card-content>
          </mat-card>



        <mat-card class="table-card" appearance="outlined">
          <mat-card-header>
            <mat-card-title>{{ 'dashboard.resource_loading' | transloco }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <table mat-table [dataSource]="[
              { label: ('dashboard.actual_to_date_qty' | transloco), value: d.rsrcQtyActualToDate },
              { label: ('dashboard.remaining_qty'     | transloco), value: d.rsrcQtyRemaining },
              { label: ('dashboard.budgeted_qty'     | transloco), value: d.rsrcQtyBudgeted },
              { label: ('dashboard.this_period_qty'  | transloco), value: d.rsrcQtyThisPeriod }
            ]">
              <ng-container matColumnDef="label">
                <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.units' | transloco }}</th>
                <td mat-cell *matCellDef="let r">{{ r.label }}</td>
              </ng-container>
        
              <ng-container matColumnDef="qty">
                <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.qty' | transloco }}</th>
                <td mat-cell *matCellDef="let r">{{ (r.value ?? 0) | number:'1.0-2' }}</td>
              </ng-container>
        
              <tr mat-header-row *matHeaderRowDef="['label','qty']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['label','qty'];"></tr>
            </table>
          </mat-card-content>
        </mat-card>
        </div>
                  <div>
            
  <mat-card class="table-card" appearance="outlined">
    <mat-card-header>
      <mat-card-title>
        {{ 'dashboard.costByResources' | transloco : { defaultValue: 'Cost by resources' } }}
      </mat-card-title>

      <div style="margin-left:auto; display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
        
        <mat-form-field appearance="outline" style="min-width: 320px;">
          <mat-label>
            {{ 'dashboard.period' | transloco : { defaultValue: 'Period' } }}
          </mat-label>

          <mat-date-range-input [rangePicker]="pickerCost">
            <input matStartDate [placeholder]="'common.start' | transloco : { defaultValue: 'Start' }"
                   [value]="startDate" (dateChange)="onStartChange($event)" />
            <input matEndDate [placeholder]="'common.end' | transloco : { defaultValue: 'End' }"
                   [value]="endDate" (dateChange)="onEndChange($event)" />
          </mat-date-range-input>

          <mat-datepicker-toggle matSuffix [for]="pickerCost"></mat-datepicker-toggle>
          <mat-date-range-picker #pickerCost></mat-date-range-picker>
        </mat-form-field>

        
        <mat-form-field appearance="outline" style="min-width: 260px;">
          <mat-label>
            {{ 'dashboard.metric.cost' | transloco : { defaultValue: 'Metric (Cost)' } }}
          </mat-label>
          <mat-select [(value)]="selectedMeasureCost">
            @for (m of measureOptions; track m) {
              <mat-option [value]="m.key">
                {{ 'dashboard.measures.' + m.label | transloco }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-header>

    <mat-card-content>
      @if (loading) {
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      }

      @if (error) {
        <div class="hpc-error">
          <mat-icon color="warn" aria-hidden="true">error_outline</mat-icon>
          <span>{{ error }}</span>
          <button mat-stroked-button color="primary" (click)="loadHistogram()">
            {{ 'common.retry' | transloco : { defaultValue: 'Retry' } }}
          </button>
        </div>
      }

      @if (!loading && !error) {
        <histogramPivotChart
          [data]="histogramCostResult"
          [height]="360"
          [value]="selectedMeasureCost">
        </histogramPivotChart>
      }
    </mat-card-content>
  </mat-card>
</div>
<div class="tables">
                  <!-- Cost loading -->
          <mat-card class="table-card" appearance="outlined">
          <mat-card-header>
            <mat-card-title>{{ 'dashboard.cost_loading' | transloco }}</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <table mat-table [dataSource]="[
            
              { label: ('dashboard.actual_to_date'   | transloco), amount: d.costActualToDate },
              { label: ('dashboard.remaining_cost'   | transloco), amount: d.costRemaining },
              { label: ('dashboard.budgeted_cost'    | transloco), amount: d.costBudgeted },
              { label: ('dashboard.this_period_cost' | transloco), amount: d.costThisPeriod }
            ]">

              <ng-container matColumnDef="label">
                <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.cost' | transloco }}</th>
                <td mat-cell *matCellDef="let r">{{ r.label }}</td>
              </ng-container>

              <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.amount' | transloco }}</th>
                <td mat-cell *matCellDef="let r">  @if (d.baseCurrency) {
                  {{ r.amount | currency : d.baseCurrency : 'symbol-narrow' : '1.0-2' }}
                } @else {
                  {{ r.amount | number:'1.0-2' }}
                }</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['label','amount']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['label','amount'];"></tr>
            </table>
          </mat-card-content>
        </mat-card>

        <mat-card class="table-card" appearance="outlined">
          <mat-card-header>
            <mat-card-title>{{ 'dashboard.float.title' | transloco }}</mat-card-title>
          </mat-card-header>
        
          <mat-card-content>
            <table mat-table [dataSource]="[
              { k: ('dashboard.float.rows.critical'      | transloco), v: d.floatSummary.critical },
              { k: ('dashboard.float.rows.nearCritical'  | transloco), v: d.floatSummary.nearCritical },
              { k: ('dashboard.float.rows.normal'        | transloco), v: d.floatSummary.normal },
              { k: ('dashboard.float.rows.high'          | transloco), v: d.floatSummary.high },
              { k: ('dashboard.float.rows.longestPath'   | transloco), v: d.floatSummary.longestPath },
              { k: ('dashboard.float.rows.unknown'       | transloco), v: d.floatSummary.unknown },
              { k: ('dashboard.float.rows.total'         | transloco), v: d.floatSummary.total }
            ]">
              <ng-container matColumnDef="k">
                <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.float.bucket' | transloco }}</th>
                <td mat-cell *matCellDef="let r">{{ r.k }}</td>
              </ng-container>
        
              <ng-container matColumnDef="v">
                <th mat-header-cell *matHeaderCellDef>{{ 'dashboard.float.count' | transloco }}</th>
                <td mat-cell *matCellDef="let r">{{ r.v }}</td>
              </ng-container>
        
              <tr mat-header-row *matHeaderRowDef="['k','v']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['k','v'];"></tr>
            </table>
          </mat-card-content>
        </mat-card>
        
        </div>
      } @else {
        <div class="topbar">
          <span>{{ 'dashboard.empty' | transloco }}</span>
        </div>
      }
    }
  </div>
</div>
