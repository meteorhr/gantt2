<div class="dash-viewport dcma-split" [class.is-loading]="loading()" [attr.aria-busy]="loading() ? 'true' : null">
  <!-- LOADING OVERLAY (занимает всю область, блокирует клики) -->
  @if (loading()) {
    <div class="loading-overlay" role="progressbar" aria-label="Recalculating">
      <div class="overlay-scrim" aria-hidden="true"></div>
      <div class="overlay-bar">
        <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
      </div>
    </div>
  }

  <!-- ЛЕВАЯ ПАНЕЛЬ: таблица (30%) -->
  <div class="left-pane">
    <div class="dcma-header">
      <h3>{{ 'dcma.title' | transloco }}</h3>
      <span class="fx"></span>
      <button mat-button (click)="openSettings()" aria-label="{{ 'dcma.settingsAria' | transloco }}">
        <mat-icon>settings</mat-icon>
        <span>{{ 'common.settings' | transloco }}</span>
      </button>
    </div>

    <!-- Всегда рендерим таблицу, даже при loading() -->
    <div
      class="table-scroll"
      [style.--zone-poor]="zone.poor"
      [style.--zone-avg]="zone.average"
      [style.--zone-great]="zone.great">

      <table mat-table [dataSource]="filteredRows()" class="fullw" [trackBy]="trackRow">

        <!-- # -->
        <ng-container matColumnDef="check">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let r">{{ r.check }}</td>
        </ng-container>

        <!-- Название -->
        <ng-container matColumnDef="metric">
          <th mat-header-cell *matHeaderCellDef>{{ 'dcma.table.metric' | transloco }}</th>
          <td mat-cell *matCellDef="let r">{{ r.metric }}</td>
        </ng-container>

        <!-- % / Value (кружок + процент) -->
        <ng-container matColumnDef="percent">
          <th mat-header-cell *matHeaderCellDef>{{ 'dcma.table.percent' | transloco }}</th>
          <td mat-cell *matCellDef="let r">
            @if(!shouldShowPassLabel(r)){
              <span class="value-cell">
                <span class="value-dot" [style.backgroundColor]="getZoneColorFor(r)"></span>
                <span class="value-text">
                  @if (r.check === 14) {
                    {{ r.percent | number:'1.0-2' }}
                  } @else {
                    {{ formatPercent(r.percent) }}%
                  }
                </span>
              </span>
            } @else {
              <span class="status-chip" [class.ok]="r.passed" [class.bad]="!r.passed">
                {{ passLabel(r) }}
              </span>
            }
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"
            (click)="selectRow(row)"
            [class.is-selected]="selectedRow()?.check === row.check">
        </tr>

      </table>
    </div>
  </div>

  <!-- ПРАВАЯ ПАНЕЛЬ: детали (70%) -->
  <div class="right-pane" #rightPane>
    @if (!selectedRow()) {
      <div class="placeholder">
        <mat-icon>info</mat-icon>
        <div>{{ 'dcma.info.selectRow' | transloco : { default: 'Select a DCMA check on the left to view details' } }}</div>
      </div>
    } @else {
      <div class="details-shell">
        <div class="details-header">
          <div class="title">
            <span class="check-num">#{{ selectedRow()!.check }}</span>
            <span class="check-name">{{ selectedRow()!.metric }}</span>
          </div>
          <div class="meta">
            <span class="percent" *ngIf="selectedRow()!.percent !== null && selectedRow()!.percent !== undefined">
              {{ selectedRow()!.percent | number:'1.0-2' }}%
            </span>
            <mat-icon [ngClass]="selectedRow()!.passed ? 'ok' : 'bad'" class="status-icon">
              {{ selectedRow()!.passed ? 'check_circle' : 'cancel' }}
            </mat-icon>
            <button mat-icon-button (click)="openInfo(selectedRow()!)" aria-label="{{ 'common.info' | transloco }}">
              <mat-icon>info</mat-icon>
            </button>
          </div>
        </div>
        <div class="details-body">
          @if (selectedRow(); as row) {
            <ng-container
              [ngComponentOutlet]="detailsComponentFor(row.check)"
              [ngComponentOutletInputs]="{
                row: row,
                animate: animFlip(),
                zoneColor: getZoneColorFor(row),
                greatText: greatPerfText(row),
                ITEM_SIZE: ITEM_SIZE
              }">
            </ng-container>
          }
        </div>
      </div>
    }
  </div>
</div>
