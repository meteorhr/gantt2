<div class="dash-viewport dcma-split">
  <!-- ЛЕВАЯ ПАНЕЛЬ: таблица (30%) -->
  <div class="left-pane">
    <div class="dcma-header">
      <h3>{{ 'dcma.title' | transloco }}</h3>
      <span class="fx"></span>
            <button mat-button (click)="openSettings()" aria-label="{{ 'dcma.settingsAria' | transloco }}">
        <mat-icon>settings</mat-icon>
        <span>{{ 'common.settings' | transloco }}</span>
      </button>
    </div>

    @if (loading()) { <p>{{ 'common.loading' | transloco }}</p> } @else {
      <!-- Прокидываем палитру в CSS-переменные для градиента -->
      <div class="table-scroll"
        [style.--zone-poor]="zone.poor"
        [style.--zone-avg]="zone.average"
        [style.--zone-great]="zone.great">
      
        <table mat-table [dataSource]="filteredRows()" class="fullw" [trackBy]="trackRow">
      
          <!-- # -->
          <ng-container matColumnDef="check">
            <th mat-header-cell *matHeaderCellDef>#</th>
            <td mat-cell *matCellDef="let r">{{ r.check }}</td>
          </ng-container>
      
          <!-- Название -->
          <ng-container matColumnDef="metric">
            <th mat-header-cell *matHeaderCellDef>{{ 'dcma.table.metric' | transloco }}</th>
            <td mat-cell *matCellDef="let r">{{ r.metric }}</td>
          </ng-container>
      
          <!-- % / Value (кружок + процент) -->
          <ng-container matColumnDef="percent">
            <th mat-header-cell *matHeaderCellDef>{{ 'dcma.table.percent' | transloco }}</th>
            <td mat-cell *matCellDef="let r">
              @if(!shouldShowPassLabel(r)){
                <span class="value-cell">
                  <span class="value-dot" [style.backgroundColor]="getZoneColorFor(r)"></span>
                  <span class="value-text">
                    @if (r.check === 14) {
                      {{ r.percent | number:'1.0-2' }}
                    } @else {
                      {{ formatPercent(r.percent) }}%
                    }
                  </span>
                </span>
              } @else {
                <span class="status-chip" [class.ok]="r.passed" [class.bad]="!r.passed">
                  {{ passLabel(r) }}
                </span>
              }
            </td>
          </ng-container>
      
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"
              (click)="selectRow(row)"
              [class.is-selected]="selectedRow()?.check === row.check">
          </tr>
      
        </table>
      </div>
    }
  </div>

  <!-- ПРАВАЯ ПАНЕЛЬ: детали (70%) -->
  <div class="right-pane" #rightPane>
    @if (!selectedRow()) {
      <div class="placeholder">
        <mat-icon>info</mat-icon>
        <div>{{ 'dcma.info.selectRow' | transloco : { default: 'Select a DCMA check on the left to view details' } }}</div>
      </div>
    } @else {
      <div class="details-shell">
        <div class="details-header">
          <div class="title">
            <span class="check-num">#{{ selectedRow()!.check }}</span>
            <span class="check-name">{{ selectedRow()!.metric }}</span>
          </div>
          <div class="meta">
            <span class="percent" *ngIf="selectedRow()!.percent !== null && selectedRow()!.percent !== undefined">
              {{ selectedRow()!.percent | number:'1.0-2' }}%
            </span>
            <mat-icon [ngClass]="selectedRow()!.passed ? 'ok' : 'bad'" class="status-icon">
              {{ selectedRow()!.passed ? 'check_circle' : 'cancel' }}
            </mat-icon>
            <button mat-icon-button (click)="openInfo(selectedRow()!)" aria-label="{{ 'common.info' | transloco }}">
              <mat-icon>info</mat-icon>
            </button>
          </div>
        </div>
        <div class="details-body">

          @switch (selectedRow()!.check) {
            @case (1) {
              @let c1 = selectedRow()?.result?.details;
              <mat-tab-group [mat-stretch-tabs]="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <!-- заголовок -->
                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>

                    <!-- большой процент -->
                    <p class="c1-summary__percent">
                      {{ selectedRow()!.percent | number:'1.0-2' }}%
                    </p>

                    <!-- great performance -->
                    <p class="c1-summary__great">
                      {{ greatPerfText(selectedRow()!) }}
                    </p>

                    <p class="c1-summary__desc">
                      {{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}
                    </p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c1.missingTriplet' | transloco }}</strong>
                      {{ selectedRow()!.result?.missingPredecessor }}/{{ selectedRow()!.result?.missingSuccessor }}/{{ selectedRow()!.result?.missingBoth }}
                    </p>
                  </div>
                </mat-tab>

                @if ((c1?.missingPredList?.length ?? 0) > 0) {
                  <mat-tab label="{{ 'dcma.c1.missingPred' | transloco }} ({{ c1!.missingPredList.length }})">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head mat-elevation-z1">
                        <colgroup>
                          <col style="width:160px" />
                          <col />
                        </colgroup>
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.name' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport class="v-viewport"
                                                  [itemSize]="44"
                                                  [minBufferPx]="440"
                                                  [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <colgroup>
                            <col style="width:160px" />
                            <col />
                          </colgroup>
                          <tbody>
                            <tr *cdkVirtualFor="let i of c1!.missingPredList; trackBy: trackTask">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.task_name }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if ((c1?.missingSuccList?.length ?? 0) > 0) {
                  <mat-tab label="{{ 'dcma.c1.missingSucc' | transloco }} ({{ c1!.missingSuccList.length }})">
                    <div class="vtable">
                      <table class="vtable__head mat-elevation-z1">
                        <colgroup>
                          <col style="width:160px" />
                          <col />
                        </colgroup>
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.name' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <cdk-virtual-scroll-viewport class="v-viewport"
                                                  [itemSize]="44"
                                                  [minBufferPx]="440"
                                                  [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <colgroup>
                            <col style="width:160px" />
                            <col />
                          </colgroup>
                          <tbody>
                            <tr *cdkVirtualFor="let i of c1!.missingSuccList; trackBy: trackTask">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.task_name }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (2) {
              <mat-tab-group [mat-stretch-tabs]="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__percent">{{ selectedRow()!.percent | number:'1.0-2' }}%</p>
                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c2.leads' | transloco }}</strong>
                      {{ selectedRow()!.result?.leadCount }} / {{ selectedRow()!.result?.totalRelationships }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.leads?.length) {
                  <mat-tab label="{{ 'dcma.details.title' | transloco }}">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.pred' | transloco }}</th>
                            <th>{{ 'dcma.col.succ' | transloco }}</th>
                            <th>{{ 'dcma.col.type' | transloco }}</th>
                            <th>{{ 'dcma.col.lagDays' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуальный вьюпорт + ТОЛЬКО видимые строки -->
                      <cdk-virtual-scroll-viewport class="v-viewport" 
                          [itemSize]="ITEM_SIZE"                                                 
                          [minBufferPx]="440"
                          [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let l of selectedRow()!.result.details.leads; trackBy: trackLink">
                              <td>{{ l.predecessor_code || l.predecessor_task_id }}</td>
                              <td>{{ l.successor_code || l.successor_task_id }}</td>
                              <td>{{ l.link_type }}</td>
                              <td>{{ l.lag_days_8h }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (3) {
              <mat-tab-group [mat-stretch-tabs]="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__percent">{{ selectedRow()!.percent | number:'1.0-2' }}%</p>
                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c3.lags' | transloco }}</strong>
                      {{ selectedRow()!.result?.lagCount }} / {{ selectedRow()!.result?.totalRelationships }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.lags?.length) {
                  <mat-tab label="{{ 'dcma.details.title' | transloco }}">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.pred' | transloco }}</th>
                            <th>{{ 'dcma.col.succ' | transloco }}</th>
                            <th>{{ 'dcma.col.type' | transloco }}</th>
                            <th>{{ 'dcma.col.lagDays' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let l of selectedRow()!.result.details.lags; trackBy: trackLink">
                              <td>{{ l.predecessor_code || l.predecessor_task_id }}</td>
                              <td>{{ l.successor_code   || l.successor_task_id   }}</td>
                              <td>{{ l.link_type }}</td>
                              <td>{{ l.lag_days_8h }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (4) {
              <mat-tab-group [mat-stretch-tabs]="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__percent">{{ selectedRow()!.percent | number:'1.0-2' }}%</p>
                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.nonFsList?.length) {
                  <mat-tab label="{{ 'dcma.details.title' | transloco }}">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.pred' | transloco }}</th>
                            <th>{{ 'dcma.col.succ' | transloco }}</th>
                            <th>{{ 'dcma.col.type' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let x of selectedRow()!.result.details.nonFsList; trackBy: trackNonFs">
                              <td>{{ x.predecessor_code || x.predecessor_task_id }}</td>
                              <td>{{ x.successor_code   || x.successor_task_id   }}</td>
                              <td>{{ x.link_type }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (5) {
              <mat-tab-group [mat-stretch-tabs]="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__percent">{{ selectedRow()!.percent | number:'1.0-2' }}%</p>
                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c5.hard' | transloco }}</strong>
                      {{ selectedRow()!.result?.hardCount }} / {{ selectedRow()!.result?.totalWithConstraints }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.hardList?.length) {
                  <mat-tab label="{{ 'dcma.details.title' | transloco }}">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.name' | transloco }}</th>
                            <th>{{ 'dcma.col.type' | transloco }}</th>
                            <th>{{ 'dcma.col.date' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let i of selectedRow()!.result.details.hardList; trackBy: trackHard">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.task_name }}</td>
                              <td>{{ i.cstr_type }}</td>
                              <td>{{ i.cstr_date ? (i.cstr_date | date:'mediumDate') : '—' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (6) {
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__percent">{{ selectedRow()!.percent | number:'1.0-2' }}%</p>
                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c6.highFloat' | transloco }}</strong>
                      {{ selectedRow()!.result?.highFloatCount }} / {{ selectedRow()!.result?.totalEligible }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.items?.length) {
                  <mat-tab label="{{ 'dcma.c6.highFloat' | transloco }}">
                    <table mat-table [dataSource]="selectedRow()!.result.details.items" class="mat-elevation-z1 sticky-header">
                      <ng-container matColumnDef="code">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.codeId' | transloco }}</th>
                        <td mat-cell *matCellDef="let i">{{ i.task_code || i.task_id }}</td>
                      </ng-container>
                      <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.name' | transloco }}</th>
                        <td mat-cell *matCellDef="let i">{{ i.task_name }}</td>
                      </ng-container>
                      <ng-container matColumnDef="tfh">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.tfHours' | transloco }}</th>
                        <td mat-cell *matCellDef="let i">{{ i.total_float_hr_cnt }}</td>
                      </ng-container>
                      <ng-container matColumnDef="tfd">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.tfDays' | transloco }}</th>
                        <td mat-cell *matCellDef="let i">{{ i.total_float_days_8h }}</td>
                      </ng-container>
                      <ng-container matColumnDef="hpd">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.hpd' | transloco }}</th>
                        <td mat-cell *matCellDef="let i">{{ i.hours_per_day_used || '—' }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['code','name','tfh','tfd','hpd']"></tr>
                      <tr mat-row *matRowDef="let i; columns: ['code','name','tfh','tfd','hpd']"></tr>
                    </table>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (7) {
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__percent">{{ selectedRow()!.percent | number:'1.0-2' }}%</p>
                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c7.negativeFloat' | transloco }}</strong>
                      {{ selectedRow()!.result?.negativeFloatCount }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.items?.length) {
                  <mat-tab label="{{ 'dcma.c7.negativeFloat' | transloco }}">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.name' | transloco }}</th>
                            <th>{{ 'dcma.col.tfHours' | transloco }}</th>
                            <th>{{ 'dcma.col.hpd' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let i of selectedRow()!.result.details.items; trackBy: trackC7">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.task_name }}</td>
                              <td>{{ i.total_float_hr_cnt }}</td>
                              <td>{{ i.hours_per_day_used || '—' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (8) {
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__percent">{{ selectedRow()!.percent | number:'1.0-2' }}%</p>
                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c8.highDuration' | transloco }}</strong>
                      {{ selectedRow()!.result?.highDurationCount }} / {{ selectedRow()!.result?.totalEligible }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.items?.length) {
                  <mat-tab label="{{ 'dcma.c8.highDuration' | transloco }}">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.name' | transloco }}</th>
                            <th>{{ 'dcma.col.remainHours' | transloco }}</th>
                            <th>{{ 'dcma.col.remainDays' | transloco }}</th>
                            <th>{{ 'dcma.col.hpd' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let i of selectedRow()!.result.details.items; trackBy: trackC8">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.task_name }}</td>
                              <td>{{ i.remain_dur_hr_cnt }}</td>
                              <td>{{ i.remain_dur_days_8h }}</td>
                              <td>{{ i.hours_per_day_used || '—' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (9) {
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>

                    <!-- PASS / FAIL вместо процента -->
                    <p class="c1-summary__pass" [class.ok]="selectedRow()!.passed" [class.bad]="!selectedRow()!.passed">
                      {{ selectedRow()!.passed ? ('common.pass' | transloco) : ('common.fail' | transloco) }}
                    </p>

                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c9.invalidForecast' | transloco }}</strong>
                      {{ selectedRow()!.result?.invalidForecastCount }}
                    </p>
                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c9.invalidActual' | transloco }}</strong>
                      {{ selectedRow()!.result?.invalidActualCount }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.forecast?.length) {
                  <mat-tab label="{{ 'dcma.c9.forecastList' | transloco }} ({{ selectedRow()!.result.details.forecast.length }})">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.es' | transloco }}</th>
                            <th>{{ 'dcma.col.ef' | transloco }}</th>
                            <th>{{ 'dcma.col.ls' | transloco }}</th>
                            <th>{{ 'dcma.col.lf' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let i of selectedRow()!.result.details.forecast; trackBy: trackC9Forecast">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.early_start_date ? (i.early_start_date | date:'mediumDate') : '—' }}</td>
                              <td>{{ i.early_end_date   ? (i.early_end_date   | date:'mediumDate') : '—' }}</td>
                              <td>{{ i.late_start_date  ? (i.late_start_date  | date:'mediumDate') : '—' }}</td>
                              <td>{{ i.late_end_date    ? (i.late_end_date    | date:'mediumDate') : '—' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.actual?.length) {
                  <mat-tab label="{{ 'dcma.c9.actualList' | transloco }} ({{ selectedRow()!.result.details.actual.length }})">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.as' | transloco }}</th>
                            <th>{{ 'dcma.col.af' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let i of selectedRow()!.result.details.actual; trackBy: trackC9Actual">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.act_start_date ? (i.act_start_date | date:'mediumDate') : '—' }}</td>
                              <td>{{ i.act_end_date   ? (i.act_end_date   | date:'mediumDate') : '—' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (10) {
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__percent">{{ selectedRow()!.percent | number:'1.0-2' }}%</p>
                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c10.withoutResources' | transloco }}</strong>
                      {{ selectedRow()!.result?.withoutResourceCount }} /
                      {{ selectedRow()!.result?.totalEligible }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.items?.length) {
                  <mat-tab label="{{ 'dcma.c10.withoutResources' | transloco }}">
                    <div class="vtable">
                      <!-- ШАПКА (вне вьюпорта) -->
                      <table class="vtable__head mat-elevation-z1">
                        <colgroup>
                          <col style="width: 160px" />
                          <col />
                        </colgroup>
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.name' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- ТЕЛО (виртуализированное) -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="48"
                        [minBufferPx]="480"
                        [maxBufferPx]="960">
                        <table class="vtable__body mat-elevation-z1">
                          <colgroup>
                            <col style="width: 160px" />
                            <col />
                          </colgroup>
                          <tbody>
                            <tr *cdkVirtualFor="let i of selectedRow()!.result.details.items; trackBy: trackTask">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.task_name }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                      <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)"
                            class="mat-elevation-z1 sticky-header dq-table">
                        <ng-container matColumnDef="metric">
                          <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                          <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                        </ng-container>
                        <ng-container matColumnDef="value">
                          <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                          <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                        </ng-container>
                        <tr mat-header-row *matHeaderRowDef="['metric','value']; sticky: true"></tr>
                        <tr mat-row *matRowDef="let r; columns: ['metric','value']"></tr>
                      </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (11) {
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__percent">{{ selectedRow()!.percent | number:'1.0-2' }}%</p>
                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c11.missed' | transloco }}</strong>
                      {{ selectedRow()!.result?.missedCount }} / {{ selectedRow()!.result?.totalCompleted }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.items?.length) {
                  <mat-tab label="{{ 'dcma.details.title' | transloco }}">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.name' | transloco }}</th>
                            <th>{{ 'dcma.col.af' | transloco }}</th>
                            <th>{{ 'dcma.col.bl' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let i of selectedRow()!.result.details.items; trackBy: trackDetailsItems">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.task_name }}</td>
                              <td>{{ i.act_finish ? (i.act_finish | date:'mediumDate') : '—' }}</td>
                              <td>{{ i.baseline_finish ? (i.baseline_finish | date:'mediumDate') : '—' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (12) {
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)"> 
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <!-- PASS / FAIL вместо процента -->
                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>
                    <p class="c1-summary__pass" [class.ok]="selectedRow()!.passed" [class.bad]="!selectedRow()!.passed">
                      {{ selectedRow()!.passed ? ('common.pass' | transloco) : ('common.fail' | transloco) }}
                    </p>

                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c12.criticalTasks' | transloco }}</strong>
                      {{ selectedRow()!.result?.criticalCount }}
                    </p>
                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c12.singleChain' | transloco }}</strong>
                      {{ selectedRow()!.result?.isSingleChain ? ('common.yes' | transloco) : ('common.no' | transloco) }}
                    </p>
                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c12.endsAtPf' | transloco }}</strong>
                      {{ selectedRow()!.result?.reachedProjectFinish ? ('common.yes' | transloco) : ('common.no' | transloco) }}
                    </p>
                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c12.startNodes' | transloco }}</strong>
                      {{ selectedRow()!.result?.startNodesOnCP }}
                    </p>
                    <p class="c1-summary__line">
                      <strong>{{ 'dcma.c12.endNodes' | transloco }}</strong>
                      {{ selectedRow()!.result?.endNodesOnCP }}
                    </p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (13) {
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>

                    <!-- PASS / FAIL вместо процента -->
                    <p class="c1-summary__pass" [class.ok]="selectedRow()!.passed" [class.bad]="!selectedRow()!.passed">
                      {{ selectedRow()!.passed ? ('common.pass' | transloco) : ('common.fail' | transloco) }}
                    </p>

                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line"><strong>{{ 'dcma.c13.cpl' | transloco }}</strong> {{ selectedRow()!.result?.criticalPathLengthDays }} {{ 'common.daysShort' | transloco }}</p>
                    <p class="c1-summary__line"><strong>{{ 'dcma.c13.ptf' | transloco }}</strong> {{ selectedRow()!.result?.projectTotalFloatDays }} {{ 'common.daysShort' | transloco }}</p>
                    <p class="c1-summary__line"><strong>{{ 'dcma.c13.cpli' | transloco }}</strong> {{  selectedRow()!.result?.cpli }}</p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }

            @case (14) {
              <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" (selectedTabChange)="onTabChange($event)">
                <mat-tab label="{{ 'dcma.summary' | transloco }}">
                  <div #c1Summary class="c1-summary"
                       [class.animate-border]="animFlip()"
                       [style.--c]="getZoneColorFor(selectedRow()!)">

                    <svg class="c1-summary__border"
                         [attr.viewBox]="'0 0 ' + sumW() + ' ' + sumH()"
                         preserveAspectRatio="none" aria-hidden="true">
                      <path [attr.d]="summaryBorderPath()" pathLength="1"></path>
                    </svg>

                    <p class="c1-summary__title">{{ selectedRow()!.metric }}</p>

                    <!-- BEI без знака %, пусто -> 0 -->
                    <p class="c1-summary__percent">
                      {{ (selectedRow()!.percent ?? 0) | number:'1.0-2' }}
                    </p>

                    <p class="c1-summary__great">{{ greatPerfText(selectedRow()!) }}</p>
                    <p class="c1-summary__desc">{{ ('dcma.checkDesc.' + selectedRow()!.check) | transloco }}</p>

                    <p class="c1-summary__line"><strong>{{ 'dcma.c13.cpl' | transloco }}</strong> {{ selectedRow()!.result?.criticalPathLengthDays }} {{ 'common.daysShort' | transloco }}</p>
                    <p class="c1-summary__line"><strong>{{ 'dcma.c13.ptf' | transloco }}</strong> {{ selectedRow()!.result?.projectTotalFloatDays }} {{ 'common.daysShort' | transloco }}</p>
                    <p class="c1-summary__line"><strong>{{ 'dcma.c13.cpli' | transloco }}</strong> {{ selectedRow()!.result?.cpli }}</p>
                  </div>
                </mat-tab>

                @if (selectedRow()!.result?.details?.plannedButNotCompleted?.length) {
                  <mat-tab label="{{ 'dcma.c14.plannedNotCompleted' | transloco }} ({{ selectedRow()!.result.details.plannedButNotCompleted.length }})">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.name' | transloco }}</th>
                            <th>{{ 'dcma.col.bl' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let i of selectedRow()!.result.details.plannedButNotCompleted; trackBy: trackC14Planned">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.task_name }}</td>
                              <td>{{ i.baseline_finish ? (i.baseline_finish | date:'mediumDate') : '—' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.completedAheadOfPlan?.length) {
                  <mat-tab label="{{ 'dcma.c14.completedAhead' | transloco }} ({{ selectedRow()!.result.details.completedAheadOfPlan.length }})">
                    <div class="vtable">
                      <!-- фиксированная шапка -->
                      <table class="vtable__head">
                        <thead>
                          <tr>
                            <th>{{ 'dcma.col.codeId' | transloco }}</th>
                            <th>{{ 'dcma.col.name' | transloco }}</th>
                            <th>{{ 'dcma.col.af' | transloco }}</th>
                            <th>{{ 'dcma.col.bl' | transloco }}</th>
                          </tr>
                        </thead>
                      </table>

                      <!-- виртуализированное тело -->
                      <cdk-virtual-scroll-viewport
                        class="v-viewport"
                        [itemSize]="ITEM_SIZE"
                        [minBufferPx]="440"
                        [maxBufferPx]="880">
                        <table class="vtable__body mat-elevation-z1">
                          <tbody>
                            <tr *cdkVirtualFor="let i of selectedRow()!.result.details.completedAheadOfPlan; trackBy: trackC14Ahead">
                              <td>{{ i.task_code || i.task_id }}</td>
                              <td>{{ i.task_name }}</td>
                              <td>{{ i.act_finish ? (i.act_finish | date:'mediumDate') : '—' }}</td>
                              <td>{{ i.baseline_finish ? (i.baseline_finish | date:'mediumDate') : '—' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </cdk-virtual-scroll-viewport>
                    </div>
                  </mat-tab>
                }

                @if (selectedRow()!.result?.details?.dq) {
                  <mat-tab label="{{ 'common.dq' | transloco }}">
                    <table mat-table [dataSource]="(selectedRow()!.result.details.dq | keyvalue)" class="mat-elevation-z1 sticky-header dq-table">
                      <ng-container matColumnDef="metric">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.metric' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ ('dcma.dq.' + k.key) | transloco }}</td>
                      </ng-container>
                      <ng-container matColumnDef="value">
                        <th mat-header-cell *matHeaderCellDef>{{ 'dcma.col.value' | transloco }}</th>
                        <td mat-cell *matCellDef="let k">{{ k.value }}</td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="['metric','value']"></tr>
                      <tr mat-row *matRowDef="let row; columns: ['metric','value']"></tr>
                    </table>
                  </mat-tab>
                }
              </mat-tab-group>
            }
          }
        </div>
      </div>
    }
  </div>
</div>