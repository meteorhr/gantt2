<!-- src/app/gantt/gantt-canvas.component.html -->

<!-- ВЕРХНИЙ TOOLBAR -->
<div class="page-toolbar">
  <div class="proj-ops">
    <button mat-icon-button type="button" (click)="expandAll()" matTooltip="Expand all" aria-label="Expand all">
      <mat-icon>unfold_more</mat-icon>
    </button>
    <button mat-icon-button type="button" (click)="collapseAll()" matTooltip="Collapse all" aria-label="Collapse all">
      <mat-icon>unfold_less</mat-icon>
    </button>
  </div>

  <div class="gantt-toolbar">
    @if(showGantt){
      <div class="zoom">
         <span class="zoom-label">Timescale</span>
        <button mat-icon-button (click)="bumpScale(-1)" matTooltip="Zoom out" aria-label="Zoom out">
           <mat-icon>remove</mat-icon>
        </button>
        <mat-slider
          class="example-margin"
          [min]="1"
          [max]="50"
          [step]="1"
          [discrete]="true"
          [showTickMarks]="false"
          aria-label="Timescale"
        >
          <input
            matSliderThumb
            [(ngModel)]="ganttPxPerDay"
            (ngModelChange)="setTimescale($event, 'center')"
            #slider
          />
        </mat-slider>
        <button mat-icon-button type="button" (click)="bumpScale(1)" matTooltip="Zoom in" aria-label="Zoom in">
          <mat-icon>add</mat-icon>
        </button>
        <button mat-icon-button type="button" (click)="zoomToFit()" matTooltip="Fit to tasks" aria-label="Fit to tasks">
          <mat-icon>fit_screen</mat-icon>
        </button>
       
      </div>
      <button mat-icon-button [matMenuTriggerFor]="ganttSettingsMenu" aria-label="Settings" matTooltip="Settings">
        <mat-icon>settings</mat-icon>
      </button>
      <mat-menu #ganttSettingsMenu="matMenu">
        <div class="menu-section" style="padding: 8px 12px; max-width: 260px;" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
          <div style="font-weight:600; margin-bottom:8px;">Gantt Settings</div>
          <mat-form-field appearance="fill" style="width:100%;">
            <mat-label>Scale</mat-label>
            <mat-select [value]="ganttScale" (selectionChange)="onScaleChange($event)">
              <mat-option [value]="'week-day'">week | day</mat-option>
              <mat-option [value]="'month-week'">month | week</mat-option>
              <mat-option [value]="'quarter-month'">quarter | month</mat-option>
              <mat-option [value]="'year-month'">year | month</mat-option>
              <mat-option [value]="'year-quarter'">year | quarter</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-menu>
    }
    <button mat-icon-button type="button" (click)="toggleGantt()" [matTooltip]="showGantt ? 'Hide Gantt' : 'Show Gantt'" aria-label="Toggle Gantt">
      <mat-icon>{{ showGantt ? 'visibility_off' : 'visibility' }}</mat-icon>
    </button>
  </div>
</div>

<!-- ОСНОВНОЕ СОДЕРЖИМОЕ -->
<div class="center">
  <div #splitRoot class="split-root">
    <!-- Левая панель (ТАБЛИЦА) -->
    <div class="pane pane-left" [style.flex-basis.%]="showGantt ? leftPct : 100">
      <div #host class="gantt-host">
        <!-- шапка таблицы -->
        <canvas #headerCanvas class="gantt-header-canvas"></canvas>

        <!-- прокручиваемое тело таблицы -->
        <div #bodyWrapper class="gantt-body-wrapper">
          <canvas #canvas class="gantt-body-overlay"></canvas>

          <!-- overlay-канвас ДОЛЖЕН быть ВНУТРИ wrapper -->
          <gantt-table-context-menu
            [open]="tableMenuOpen"
            [x]="tableMenuX"
            [y]="tableMenuY"
            (closed)="closeTableMenu()"
            (insertBefore)="onMenuInsertBefore()"
            (insertAfter)="onMenuInsertAfter()"
            (deleteRow)="onMenuDeleteRow()"
            (duplicateRow)="onMenuDuplicateRow()"
          ></gantt-table-context-menu>

          <div #tableSpacer class="gantt-spacer"></div>
        </div>
      </div>
    </div>

    <!-- Разделитель -->
    <div
      class="splitter"
      (mousedown)="onSplitMouseDown($event)"
      [style.display]="showGantt ? '' : 'none'">
    </div>

    <!-- Правая панель (ГАНТТ) -->
    <div
      class="pane pane-right"
      [style.flex-basis.%]="100 - leftPct"
      [style.display]="showGantt ? '' : 'none'">
      <div #ganttHost class="gantt-host">
        <!-- шапка ганта -->
        <canvas #ganttHeaderCanvas class="gantt-header-canvas"></canvas>
        @if (ganttTooltipOpen && ganttTooltipData) {
          <gantt-tooltip
            [open]="ganttTooltipOpen"
            [x]="ganttTooltipX"
            [y]="ganttTooltipY"
            [data]="ganttTooltipData">
          </gantt-tooltip>
        }
        <!-- прокручиваемое тело ганта -->
        <div #ganttWrapper class="gantt-body-wrapper">
          <canvas #ganttCanvas class="gantt-body-overlay"></canvas>
          <div #ganttSpacer class="gantt-spacer"></div>
        </div>

      </div>
    </div>
  </div>
</div>
